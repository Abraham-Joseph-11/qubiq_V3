let c=null,d=null,l=null;self.onmessage=async t=>{const{type:o,data:n}=t.data;try{if(o==="load")await f(e=>{self.postMessage({type:"progress",data:e})}),self.postMessage({type:"loaded"});else if(o==="generate"){await f(a=>{self.postMessage({type:"progress",data:a})});const e=await h(n.prompt,a=>{self.postMessage({type:"progress",data:a})});self.postMessage({type:"complete",data:e})}}catch(e){self.postMessage({type:"error",data:e.message})}};const f=async t=>{if(c&&d)return{tokenizer:c,model:d};l||(l=await import("./transformers.web-BIiR3S_u.js"),l.env.allowLocalModels=!1,l.env.useBrowserCache=!0,l.env.token=null);const{AutoTokenizer:o,MusicgenForConditionalGeneration:n}=l,e="Xenova/musicgen-small";return console.log(`Loading tokenizer from ${e}...`),c=await o.from_pretrained(e,{progress_callback:a=>{t&&t(a)}}),console.log(`Loading model from ${e} with WASM execution...`),d=await n.from_pretrained(e,{progress_callback:a=>{t&&t(a)},dtype:{text_encoder:"q8",decoder_model_merged:"q8",encodec_decode:"fp32"},device:"wasm"}),console.log("Model and tokenizer loaded successfully!"),t&&t({status:"ready",file:"all"}),{tokenizer:c,model:d}},h=async(t,o)=>{const{tokenizer:n,model:e}=await f(o);let a=t;a.toLowerCase().includes("happy birthday")&&(a="Happy Birthday to You, traditional celebration song melody, clear instrumental",console.log(`Override prompt for 'Happy Birthday': "${a}"`));const g=n(a),m=await e.generate({...g,do_sample:!0,guidance_scale:4,temperature:.7,max_new_tokens:600});console.log("Generation complete");let r=m.data,i=0;for(let s=0;s<r.length;s++){const p=Math.abs(r[s]);p>i&&(i=p)}if(i>.99)for(let s=0;s<r.length;s++)r[s]/=i;const y=M(r,32e3),w=new Blob([y],{type:"audio/wav"});return URL.createObjectURL(w)};function M(t,o){const n=new ArrayBuffer(44+t.length*2),e=new DataView(n);return u(e,0,"RIFF"),e.setUint32(4,32+t.length*2,!0),u(e,8,"WAVE"),u(e,12,"fmt "),e.setUint32(16,16,!0),e.setUint16(20,1,!0),e.setUint16(22,1,!0),e.setUint32(24,o,!0),e.setUint32(28,o*2,!0),e.setUint16(32,2,!0),e.setUint16(34,16,!0),u(e,36,"data"),e.setUint32(40,t.length*2,!0),U(e,44,t),n}function U(t,o,n){for(let e=0;e<n.length;e++,o+=2){const a=Math.max(-1,Math.min(1,n[e]));t.setInt16(o,a<0?a*32768:a*32767,!0)}}function u(t,o,n){for(let e=0;e<n.length;e++)t.setUint8(o+e,n.charCodeAt(e))}
